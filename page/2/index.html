<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Artemio&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Artemio&#39;s Blog">
<meta property="og:url" content="https://ostart.github.io/page/2/index.html">
<meta property="og:site_name" content="Artemio&#39;s Blog">
<meta property="og:locale" content="ru_RU">
<meta property="article:author" content="Artem Ostashchenko">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Artemio's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Artemio&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Hi, I&#39;m Artem Ostashchenko, a software developer. I write this blog in Russian</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" target="_blank" rel="noopener" href="https://github.com/ostart/Skills">My Skills</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS-каналы"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Поиск"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Поиск"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://ostart.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-sorting-tuples" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/03/31/sorting-tuples/" class="article-date">
  <time class="dt-published" datetime="2022-03-31T10:45:30.000Z" itemprop="datePublished">31-03-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/03/31/sorting-tuples/">Сортировка кортежей</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Создание кортежа с помощью конструктора выглядит громоздко. Чтобы облегчить синтаксис создания кортежей существует класс <code>Tuple</code> с серией статических методов, создающих кортежи:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t1 = Tuple.Create(<span class="number">42</span>, <span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="comment">// Эквивалентно:</span></span><br><span class="line"><span class="comment">// var t1 = new Tuple&lt;int, string&gt;(42, &quot;abc&quot;);</span></span><br></pre></td></tr></table></figure>

<p>Полезное свойство кортежей состоит в том, что они реализуют интерфейс <code>IComparable</code>, сравнивающий кортежи по компонентам. То есть Tuple.Create(1, 2) будет меньше Tuple.Create(2, 1). Этот интерфейс по умолчанию используется в методах сортировки и поиска минимума/максимума.</p>
<p>Использование данного факта рассмотрим на примере:</p>
<p>Дан текст. Нужно составить список всех встречающихся в тексте слов, упорядоченный сначала по возрастанию длины слова, а потом лексикографически. Удивительно, но данную задачу можно решить совсем не используя <code>ThenBy</code>.</p>
<p>Наивное решение заключается в том, чтобы сформировать нужные кортежи, отсортировать их, а затем извлечь вторые компоненты кортежей, содержащих решение:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="built_in">string</span>&gt;  <span class="title">GetSortedWords</span>(<span class="params"><span class="built_in">string</span> text</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> Regex.Split(text, <span class="string">@&quot;\W+&quot;</span>)</span><br><span class="line">                .Where(x =&gt; x.Length &gt; <span class="number">0</span>)</span><br><span class="line">                .Select(t =&gt; Tuple.Create(t.Length, t.ToLowerInvariant()))</span><br><span class="line">                .OrderBy(x =&gt; x)</span><br><span class="line">                .Select(x =&gt; x.Item2)</span><br><span class="line">                .Distinct()</span><br><span class="line">                .ToList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Однако следует напомнить, что keySelector функции OrderBy — это функция, которая каждому элементу последовательности ставит в соответствие некоторый ключ, по которому его будут сравнивать при сортировке. Поэтому решение можно записать намного короче, поместив кортеж (типа ValueTuple) в keySelector функции OrderBy:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="built_in">string</span>&gt;  <span class="title">GetSortedWords</span>(<span class="params"><span class="built_in">string</span> text</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> Regex.Split(text.ToLower(), <span class="string">@&quot;\W+&quot;</span>)</span><br><span class="line">                .Where(x =&gt; !<span class="built_in">string</span>.IsNullOrEmpty(x))</span><br><span class="line">                .OrderBy(x =&gt; (x.Length, x))</span><br><span class="line">                .Distinct()</span><br><span class="line">                .ToList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Вывод программы можно увидеть ниже:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GetSortedWords(&quot;A box of biscuits, a box of mixed biscuits, and a biscuit mixer.&quot;)</span><br><span class="line">&#x27;a&#x27; &#x27;of&#x27; &#x27;and&#x27; &#x27;box&#x27; &#x27;mixed&#x27; &#x27;mixer&#x27; &#x27;biscuit&#x27; &#x27;biscuits&#x27;</span><br><span class="line"></span><br><span class="line">GetSortedWords(&quot;Each Easter Eddie eats eighty Easter eggs.&quot;)</span><br><span class="line">&#x27;each&#x27; &#x27;eats&#x27; &#x27;eggs&#x27; &#x27;eddie&#x27; &#x27;easter&#x27; &#x27;eighty&#x27;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/03/31/sorting-tuples/" data-id="cljdu360x00288ovs0otye3jr" data-title="Сортировка кортежей" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-order-by" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/03/31/order-by/" class="article-date">
  <time class="dt-published" datetime="2022-03-31T09:49:02.000Z" itemprop="datePublished">31-03-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/03/31/order-by/">LINQ оператор OrderBy</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Для сортировки последовательности в LINQ имеется четыре метода:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">IOrderedEnumerable</span>&lt;<span class="title">T</span>&gt; <span class="title">OrderBy</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IEnumerable&lt;T&gt; items, Func&lt;T, K&gt; keySelector</span>)</span>;</span><br><span class="line"><span class="function"><span class="title">IOrderedEnumerable</span>&lt;<span class="title">T</span>&gt; <span class="title">OrderByDescending</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IEnumerable&lt;T&gt; items, Func&lt;T, K&gt; keySelector</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">IOrderedEnumerable</span>&lt;<span class="title">T</span>&gt; <span class="title">ThenBy</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IOrderedEnumerable&lt;T&gt; items, Func&lt;T, K&gt; keySelector</span>)</span>;</span><br><span class="line"><span class="function"><span class="title">IOrderedEnumerable</span>&lt;<span class="title">T</span>&gt; <span class="title">ThenByDescending</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IOrderedEnumerable&lt;T&gt; items, Func&lt;T, K&gt; keySelector</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>Первые два дают на выходе последовательность, упорядоченную по возрастанию/убыванию ключей. А keySelector — это как раз функция, которая каждому элементу последовательности ставит в соответствие некоторый ключ, по которому его будут сравнивать при сортировке.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> names = <span class="keyword">new</span>[] &#123; <span class="string">&quot;Pavel&quot;</span>, <span class="string">&quot;Alexander&quot;</span>, <span class="string">&quot;Anna&quot;</span> &#125;;</span><br><span class="line">IOrderedEnumerable&lt;<span class="built_in">string</span>&gt; sorted = names.OrderBy(n =&gt; n.Length);</span><br><span class="line">Assert.That(sorted, Is.EqualTo(<span class="keyword">new</span>[] &#123; <span class="string">&quot;Anna&quot;</span>, <span class="string">&quot;Pavel&quot;</span>, <span class="string">&quot;Alexander&quot;</span> &#125;));</span><br></pre></td></tr></table></figure>

<p>Если при равенстве ключей вы хотите отсортировать элементы по другому критерию, то на помощь приходит метод ThenBy.</p>
<p>Например, в следующем примере все имена сортируются по убыванию длин, а при равных длинах — лексикографически.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> names = <span class="keyword">new</span>[] &#123; <span class="string">&quot;Pavel&quot;</span>, <span class="string">&quot;Alexander&quot;</span>, <span class="string">&quot;Irina&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sorted = names</span><br><span class="line">    .OrderByDescending(name =&gt; name.Length)</span><br><span class="line">    .ThenBy(n =&gt; n);</span><br><span class="line"></span><br><span class="line">Assert.That(sorted, Is.EqualTo(<span class="keyword">new</span>[] &#123; <span class="string">&quot;Alexander&quot;</span>, <span class="string">&quot;Irina&quot;</span>, <span class="string">&quot;Pavel&quot;</span> &#125;).AsCollection);</span><br></pre></td></tr></table></figure>

<p>Чтобы убрать из последовательности все повторяющиеся элементы используют LINQ функцию Distinct:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers = <span class="keyword">new</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, &#125;;</span><br><span class="line"><span class="keyword">var</span> uniqueNumbers = numbers.Distinct();</span><br><span class="line">Assert.That(uniqueNumbers, Is.EqualTo(<span class="keyword">new</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;).AsCollection));</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/03/31/order-by/" data-id="cljdu360h00188ovs6c42aubp" data-title="LINQ оператор OrderBy" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LINQ/" rel="tag">LINQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OrderBy/" rel="tag">OrderBy</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-select-many" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/03/22/select-many/" class="article-date">
  <time class="dt-published" datetime="2022-03-22T06:14:08.000Z" itemprop="datePublished">22-03-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/03/22/select-many/">LINQ оператор SelectMany</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>В LINQ есть такой необычный оператор, как <code>SelectMany</code>. В чем же его необычность?</p>
<p>Рассмотрим сигнатуру метода:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IEnumerable&lt;R&gt; <span class="title">SelectMany</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;T&gt; items, Func&lt;T, IEnumerable&lt;R&gt;&gt; f</span>)</span></span><br></pre></td></tr></table></figure>

<p>Из сигнатуры метода <code>SelectMany</code> видно, что он применяется к последовательности типа <code>IEnumerable&lt;T&gt;</code>. К каждому элементу этой последовательности применяется функция <code>Func&lt;T, IEnumerable&lt;R&gt;&gt;</code>, которая преобразует элемент типа <code>T</code> в последовательность типа <code>IEnumerable&lt;R&gt;</code>. И на выходе мы имеем последовательность типа <code>IEnumerable&lt;R&gt;</code>. Получается, что каждый элемент превращается в множество, которое может быть закрыто отличным типом от исходного, которое затем спрямляется. Результатом работы <code>SelectMany</code> является конкатенация всех полученных последовательностей, т.е. мы имеем не последовательность последовательностей, а единую последовательность типа, отличного от исходного (не обязательно отличного, можно получить и последовательность того же типа).</p>
<p>Поясним вышесказанное следующим примером:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span>[] words = &#123;<span class="string">&quot;ab&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;de&quot;</span>&#125;;</span><br><span class="line">IEnumerable&lt;<span class="built_in">char</span>&gt; letters = words.SelectMany(w =&gt; w.ToCharArray());</span><br><span class="line">Assert.That(letters, Is.EqualTo(<span class="keyword">new</span>[] &#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>&#125;));</span><br></pre></td></tr></table></figure>

<p>Впрочем строка уже сама по себе является последовательностью символов и реализует интерфейс IEnumerable<char>, поэтому вызов ToCharArray на самом деле лишний.</p>
<p>Одно из не совсем очевидных применений <code>SelectMany</code> — это вычисление декартова произведения двух множеств. Декартово произведение множества {-1, 0, 1} на само себя даст все возможные относительные координаты соседей условной точки Point, где Point – класс, имеющий координаты X и Y в качестве открытых полей. Для вычисления декартова произведения двух множеств также потребуется использовать метод <code>Select</code> внутри <code>SelectMany</code>, как показано в примере ниже:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;Point&gt; <span class="title">GetNeighbours</span>(<span class="params">Point p</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span>[] d = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">return</span> d.SelectMany(i =&gt; d.Select(s =&gt; <span class="keyword">new</span> Point(p.X + i, p.Y + s)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Вот ещё один интересный пример использования <code>SelectMany</code>. Требуется составить лексикографически упорядоченный список всех встречающихся слов в массиве строк. Слова нужно сравнивать регистронезависимо и выводить в нижнем регистре.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">var</span> vocabulary = GetSortedWords(</span><br><span class="line">  <span class="string">&quot;Hello, hello, hello, how low&quot;</span>,</span><br><span class="line">  <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;With the lights out, it&#x27;s less dangerous&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Here we are now; entertain us&quot;</span>,</span><br><span class="line">  <span class="string">&quot;I feel stupid and contagious&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Here we are now; entertain us&quot;</span>,</span><br><span class="line">  <span class="string">&quot;A mulatto, an albino, a mosquito, my libido...&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Yeah, hey&quot;</span></span><br><span class="line"> );</span><br><span class="line"> <span class="keyword">foreach</span> (<span class="keyword">var</span> word <span class="keyword">in</span> vocabulary)</span><br><span class="line">  Console.WriteLine(word);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span>[] <span class="title">GetSortedWords</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">string</span>[] textLines</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">return</span> textLines</span><br><span class="line">       .SelectMany(x =&gt; Regex.Split(x.ToLower(), <span class="string">@&quot;\W+&quot;</span>))</span><br><span class="line">       .Where(x =&gt; x.Length &gt; <span class="number">0</span>)</span><br><span class="line">       .Distinct()</span><br><span class="line">       .OrderBy(x =&gt; x)</span><br><span class="line">       .ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Здесь для разбиения строки на слова используется класс <code>Regex</code> из пространства имён <code>System.Text.RegularExpressions</code>. Все полученные слова “спрямляются” (объединяются из разных массивов в один массив), удаляются пустые строки и повторы. В конце массив лексикографически упорядочивается и возвращается.</p>
<p>Без использования <code>SelectMany</code> пришлось бы очень трудно, т.к. каждая входящая строка после разбиения <code>Regex.Split</code> превращается в массив слов и мы бы получили массив массивов.</p>
<p>Вывод программы можно увидеть ниже:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">albino</span><br><span class="line">an</span><br><span class="line">and</span><br><span class="line">are</span><br><span class="line">contagious</span><br><span class="line">dangerous</span><br><span class="line">entertain</span><br><span class="line">feel</span><br><span class="line">hello</span><br><span class="line">here</span><br><span class="line">hey</span><br><span class="line">how</span><br><span class="line">i</span><br><span class="line">it</span><br><span class="line">less</span><br><span class="line">libido</span><br><span class="line">lights</span><br><span class="line">low</span><br><span class="line">mosquito</span><br><span class="line">mulatto</span><br><span class="line">my</span><br><span class="line">now</span><br><span class="line">out</span><br><span class="line">s</span><br><span class="line">stupid</span><br><span class="line">the</span><br><span class="line">us</span><br><span class="line">we</span><br><span class="line">with</span><br><span class="line">yeah</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/03/22/select-many/" data-id="cljdu360p001r8ovsak5b2qbg" data-title="LINQ оператор SelectMany" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LINQ/" rel="tag">LINQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SelectMany/" rel="tag">SelectMany</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-int-to-guid" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/03/17/int-to-guid/" class="article-date">
  <time class="dt-published" datetime="2022-03-17T09:53:42.000Z" itemprop="datePublished">17-03-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/03/17/int-to-guid/">Как преобразовать int в Guid заданным способом</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Потребовалось давеча в рамках тестирования формировать <code>Guid</code> таким образом, чтобы он генерировался не случайно, а нужным мне управляемым способом. А именно так, чтобы при использовании цикла <code>for</code> по <code>int</code> формировался <code>Guid</code> следующим образом:</p>
<p>для int = 1 получить Guid = ‘00000000-0000-0000-0000-000000000001’<br>для int = 2 получить Guid = ‘00000000-0000-0000-0000-000000000002’<br>для int = 3 получить Guid = ‘00000000-0000-0000-0000-000000000003’</p>
<p>и так далее…</p>
<p>Как этого добиться? Решение данной задачи представлено ниже:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Guid <span class="title">ToGuid</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">16</span>];</span><br><span class="line">    BitConverter.GetBytes(<span class="keyword">value</span>).CopyTo(bytes, <span class="number">0</span>);</span><br><span class="line">    bytes = bytes.Reverse().ToArray();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Guid(bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/03/17/int-to-guid/" data-id="cljdu3604000o8ovse2pg90o8" data-title="Как преобразовать int в Guid заданным способом" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Guid/" rel="tag">Guid</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-switch-by-property-values" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/03/17/switch-by-property-values/" class="article-date">
  <time class="dt-published" datetime="2022-03-17T07:26:48.000Z" itemprop="datePublished">17-03-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/03/17/switch-by-property-values/">Сопоставление с образцом на основе значений свойств объекта</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Рассмотрим класс комнаты и перечисление статуса члена клуба такого вида:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Room</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Number &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Type &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Size &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> Membership</span><br><span class="line">&#123;</span><br><span class="line">    Bronze,</span><br><span class="line">    Silver,</span><br><span class="line">    Gold</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Метод <code>GetRooms</code> возвращает список комнат вида:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Room&gt; <span class="title">GetRooms</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> List&lt;Room&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> Room</span><br><span class="line">        &#123;</span><br><span class="line">            Number = <span class="number">3</span>,</span><br><span class="line">            Size = <span class="string">&quot;Large&quot;</span>,</span><br><span class="line">            Type = <span class="string">&quot;Deluxe&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> Room</span><br><span class="line">        &#123;</span><br><span class="line">            Number = <span class="number">2</span>,</span><br><span class="line">            Size = <span class="string">&quot;Large&quot;</span>,</span><br><span class="line">            Type = <span class="string">&quot;Regular&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> Room</span><br><span class="line">        &#123;</span><br><span class="line">            Number = <span class="number">1</span>,</span><br><span class="line">            Size = <span class="string">&quot;Standard&quot;</span>,</span><br><span class="line">            Type = <span class="string">&quot;Regular&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Начиная с C# 8.0 появилась возможность сопоставлять с образцом в выражении <code>switch</code>, используя несколько значений свойств объекта класса:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">int</span> RoomNotAvailable = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">AssignRoom</span>(<span class="params">Membership membership</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="function"><span class="keyword">var</span> room <span class="keyword">in</span> <span class="title">GetRooms</span>(<span class="params"></span>))</span></span><br><span class="line">    &#123;</span><br><span class="line">        Membership clientCategory = room <span class="keyword">switch</span></span><br><span class="line">        &#123;</span><br><span class="line">            &#123; Size: <span class="string">&quot;Large&quot;</span>, Type: <span class="string">&quot;Deluxe&quot;</span> &#125; =&gt; Membership.Gold,</span><br><span class="line">            &#123; Size: <span class="string">&quot;Large&quot;</span>, Type: <span class="string">&quot;Regular&quot;</span> &#125; =&gt; Membership.Silver,</span><br><span class="line">            &#123; Size: <span class="string">&quot;Standard&quot;</span>, Type: <span class="string">&quot;Regular&quot;</span> &#125; =&gt; Membership.Bronze,</span><br><span class="line">            _ =&gt; Membership.Bronze</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientCategory == membership)</span><br><span class="line">            <span class="keyword">return</span> room.Number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RoomNotAvailable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Код ветки <code>_ =&gt; Membership.Bronze</code> аналогичен случаю <code>default:</code> в стандартном <code>switch</code>.</p>
<p>Тогда основной метод программы может использовать вышеприведённый код таким образом:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> voir <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.Write(<span class="string">&quot;Choose status: 0 for Bronze, 1 for Silver, 2 for Gold&quot;</span>);</span><br><span class="line">    <span class="built_in">string</span> clientStatus = Console.ReadLine();</span><br><span class="line"></span><br><span class="line">    Enum.TryParse(clientStatus, <span class="keyword">out</span> Membership membership);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> roomNumber = AssignRoom(membership);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (roomNumber == RoomNotAvailable)</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Room not available&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Room number is <span class="subst">&#123;roomNumber&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Основная магия сопоставления с образцом с использованием значений свойств объектов происходит в методе <code>AssignRoom</code>. Раньше можно было делать <code>switch</code> только на основе единственного значения, но начиная с С# 8.0 паттерн матчинг можно делать на основе значений нескольких свойств экзмепляров классов. Такой подход намного более читабельный и улучшает ясность кода.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/03/17/switch-by-property-values/" data-id="cljdu3610002g8ovs061c6md4" data-title="Сопоставление с образцом на основе значений свойств объекта" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/switch/" rel="tag">switch</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-datetime-vs-stopwatch" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/24/datetime-vs-stopwatch/" class="article-date">
  <time class="dt-published" datetime="2022-02-24T08:05:33.000Z" itemprop="datePublished">24-02-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/24/datetime-vs-stopwatch/">DateTime.Now vs. Stopwatch</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Читая книгу Андрея Акиньшина “Профессиональный бенчмарк” решил проверять приводимые в книге примеры на практике (автор сам так рекомендует). Начал, конечно же, со столь любимого мною в прошлом “бенчмарка новичков”: измерения <code>DateTime.Now</code> до и после испытуемого на скорость кода и последующего вычисления разности. </p>
<p>Но вот в чем засада по словам автора: для <code>Windows10</code> частота обновления DateTime по умолчанию 64Гц. А это значит, что новое значение получается с интервалами 15,625 мс и это же значение составляет точность подхода с DateTime. Т.е для всех операций, которые выполнятся быстрее 15,625 мс мы получим значение времени выполнения интересующего кода равное 0, либо, если не повезёт, то 15,625 мс. Такая точность не всегда бывает недопустима, особенно если испытуемый на скорость код выполняется быстрее.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = Enumerable.Range(<span class="number">0</span>, <span class="number">10000</span>).ToList();</span><br><span class="line">DateTime start = DateTime.Now;</span><br><span class="line">list.Sort();</span><br><span class="line">DateTime end = DateTime.Now;</span><br><span class="line">TimeSpan elapsedTime = end - start;</span><br><span class="line">Console.WriteLine(elapsedTime.TotalMilliseconds);</span><br></pre></td></tr></table></figure>

<p>Пробую код из книги на <code>Windows10</code> C#6.0 и получаю результаты около 4,5 мс. Предсказанный Андреем 0 никак получить не удалось, как и собственно 15,625 мс.</p>
<p>Двигаемся дальше.</p>
<p>По словам автора, лучшей альтернативой <code>DateTime.Now</code> является класс <code>System.Diagnostics.Stopwatch</code>. Типичное разрешение Stopwatch в <code>Windows10</code> составляет величину порядка 300-500 нс.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = Enumerable.Range(<span class="number">0</span>, <span class="number">10000</span>).ToList();</span><br><span class="line"><span class="keyword">var</span> stopwatch = System.Diagnostics.Stopwatch.StartNew();</span><br><span class="line">list.Sort();</span><br><span class="line">stopwatch.Stop();</span><br><span class="line">TimeSpan elapsedTime = stopwatch.Elapsed;</span><br><span class="line">Console.WriteLine(elapsedTime.TotalMilliseconds);</span><br></pre></td></tr></table></figure>

<p>Этот код на машине автора выдавал результат в 0,05 мс. Однако на моей машине средний результат крутился в районе 0,491 мс, что в 10 раз больше, чем ожидалось!</p>
<p>Никакого анализа причин этих цифр пока привести не могу. Только начинаю погружаться в тонкости бенчмарка. Однако отмечу, что поведение <code>DateTime.Now</code> на моей машине много точнее, чем на машине автора, а <code>System.Diagnostics.Stopwatch</code> на моей машине на порядок хуже, чем на машине автора. В целом нужно согласиться с автором, что <code>Stopwatch</code> точнее (в моей случае на порядок), чем <code>DateTime.Now</code>.</p>
<p>Также следует иметь ввиду, что кроме низкого разрешения DateTime.Now работает медленнее DateTime.UtcNow, т.к. он пересчитывает часовые пояса. Соглашусь с советом Андрея Акиньшина, что в 99% случаев следует выбирать Stopwatch, а не DateTime. DateTime может потребоваться только в случае, если вам действительно нужно знать текущее время. Если реальное время не требуется, то используйте Stopwatch.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/02/24/datetime-vs-stopwatch/" data-id="cljdu35zy000e8ovsh4821gki" data-title="DateTime.Now vs. Stopwatch" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Benchmark/" rel="tag">Benchmark</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DateTime/" rel="tag">DateTime</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Stopwatch/" rel="tag">Stopwatch</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-swagger-xml-comments" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/24/swagger-xml-comments/" class="article-date">
  <time class="dt-published" datetime="2022-02-24T07:15:31.000Z" itemprop="datePublished">24-02-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/24/swagger-xml-comments/">Особенность отображения Swagger&#39;ом XML комментариев</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://swagger.io/">Swashbuckle Swagger</a> – это фреймворк для спецификаций RESTful API, которые выраженны с помощью JSON. Swagger используется вместе с набором программных инструментов с открытым исходным кодом для проектирования, создания, документирования и использования веб-служб RESTful. Его сильная сторона заключается в том, что он дает возможность не только интерактивно просматривать спецификацию контроллеров WebAPI, но и отправлять запросы через Swagger UI.</p>
<p>Swagger – удобный инструмент для реализации встроенной в код документации. Добавление XML-комментариев методам контроллеров делает описание методов наглядными при работе через Swagger UI. Отличное руководство по <a target="_blank" rel="noopener" href="https://docs.microsoft.com/ru-ru/aspnet/core/tutorials/getting-started-with-swashbuckle?view=aspnetcore-6.0&tabs=visual-studio">Началу работы с Swashbuckle и ASP.NET Core</a> расположено на сайте Майкрософт. Там приведены рекомендации по подключению Swagger и по оформлению XML-комментариев к методам контроллеров WebAPI.</p>
<p>Рассмотрим пример одного из таких XML-комментариев метода <code>Create</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates a TodoItem.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;item&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>A newly created TodoItem<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Sample request:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     POST /Todo</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     &#123;</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>        &quot;name&quot;: &quot;Item #1&quot;,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>        &quot;isComplete&quot;: true</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     &#125;</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;201&quot;&gt;</span>Returns the newly created item<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>If the item is null<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line">[<span class="meta">ProducesResponseType(StatusCodes.Status201Created)</span>]</span><br><span class="line">[<span class="meta">ProducesResponseType(StatusCodes.Status400BadRequest)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Create</span>(<span class="params">TodoItem item</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _context.TodoItems.Add(item);</span><br><span class="line">    <span class="keyword">await</span> _context.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CreatedAtAction(<span class="keyword">nameof</span>(Get), <span class="keyword">new</span> &#123; id = item.Id &#125;, item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Обратите внимание, как эти дополнительные комментарии улучшают пользовательский интерфейс:</p>
<img src="/2022/02/24/swagger-xml-comments/swagger-post.png" class="" title="Swagger">

<p>Однако я столкнулся со следующей проблемой: в случае присутствия одного из следующих символов: <code>&amp; &gt; &lt; “ ‘</code> в XML-комментарии, описание метода в Swagger UI полностью ломается и перестаёт отображаться, т.е. метод начинает выглядеть так, как будто никакого XML-комментария вовсе и нет.</p>
<p>Проблема заключается в природе самого XML, который по своей сути знает только об <code>&amp;amp; &amp;lt; &amp;gt; &amp;apos; &amp;quot;</code>, а также числовых объектах. Поэтому вместо <code>&amp; &gt; &lt; ‘ “</code> нужно использовать <code>&amp;amp; &amp;lt; &amp;gt; &amp;apos; &amp;quot;</code>. В таком случае комментарии к методам WebAPI  исчезать из Swagger UI не будут.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/02/24/swagger-xml-comments/" data-id="cljdu360w00268ovs6blyf4ek" data-title="Особенность отображения Swagger&#39;ом XML комментариев" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swagger/" rel="tag">Swagger</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-iasyncdisposable" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/20/iasyncdisposable/" class="article-date">
  <time class="dt-published" datetime="2022-02-20T05:43:00.000Z" itemprop="datePublished">20-02-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/20/iasyncdisposable/">Имплементация интерфейса IAsyncDisposable</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Интерфейс <code>IAsyncDisposable</code> служит для асинхронного освобождения неуправляемых ресурсов (unmanaged resources). Появился он в версии <code>.NET Core 3.0</code>. В .NET классы, владеющие неуправляемыми ресурсами, обычно реализуют интерфейс <code>IDisposable</code>, чтобы обеспечить механизм синхронного освобождения неуправляемых ресурсов (см. подробности в посте <a href="https://ostart.github.io/2022/02/19/idisposable/">Имплементация интерфейса IDisposable</a>). Однако в некоторых случаях классам необходимо предоставлять асинхронный механизм освобождения неуправляемых ресурсов в дополнение к синхронному (или вместо него). Предоставление такого механизма позволяет потребителю выполнять ресурсоемкие операции удаления не блокируя основной поток приложения с графическим интерфейсом в течение длительного времени.</p>
<p>Метод <code>IAsyncDisposable.DisposeAsync</code> этого интерфейса возвращает <code>ValueTask</code>, представляющий асинхронную операцию освобождения ресурсов. Класс, владеющий неуправляемыми ресурсами, реализует этот метод, а потребитель класса вызывает метод <code>DisposeAsync</code> объекта, когда он больше не нужен. Чтобы ресурсы освобождались даже в случае исключения следует поместить код, использующий объект IAsyncDisposable, в оператор using (в C#, начиная с версии 8.0), или вызвать метод DisposeAsync внутри finally оператора try/finally.</p>
<p>Приведём пример кода, поясняющий вышеописанное:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">SomeClass</span> : <span class="title">IAsyncDisposable</span>, <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> asyncDisposeObj = <span class="keyword">new</span> FileStream(<span class="string">&quot;SomeFile.txt&quot;</span>, FileMode.OpenOrCreate, FileAccess.Write);</span><br><span class="line">    <span class="keyword">var</span> syncDisposeObj  = <span class="keyword">new</span> HttpClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// other usefull code</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> ValueTask <span class="title">DisposeAsync</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> DisposeAsyncCore();</span><br><span class="line"></span><br><span class="line">        Dispose(disposing: <span class="literal">false</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dispose(disposing: <span class="literal">true</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (disposing)</span><br><span class="line">        &#123;</span><br><span class="line">            syncDisposeObj?.Dispose();</span><br><span class="line">            (asyncDisposeObj <span class="keyword">as</span> IDisposable)?.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DisposeThisObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">async</span> ValueTask <span class="title">DisposeAsyncCore</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (asyncDisposeObj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> asyncDisposeObj.DisposeAsync().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (syncDisposeObj <span class="keyword">is</span> IAsyncDisposable disposable)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> disposable.DisposeAsync().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            syncDisposeObj.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DisposeThisObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DisposeThisObject</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        asyncDisposeObj = <span class="literal">null</span>;</span><br><span class="line">        syncDisposeObj  = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>А где-то в приложении класс можно использовать так:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> someClass = <span class="keyword">new</span> SomeClass();</span><br><span class="line">    <span class="comment">// other usefull code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Код выше показал, в общих чертах, паттерн <code>Async Dispose Pattern</code>. Как следует из кода, asyncDisposeObj ссылается на ресурс который следует утилизировать асинхронно, а syncDisposeObj - синхронно. Теперь синхронная и асинхронная утилизация ресурсов могут выполняться в одно время, так что важно рассматривать эти процессы совместно. Для синхронной и асинхронной утилизации ресурсов класс реализует интерфейсы <code>IAsyncDisposable</code> и <code>IDisposable</code>. Как показано в посте <a href="https://ostart.github.io/2022/02/19/idisposable/">Имплементация интерфейса IDisposable</a> <code>IDisposable</code> должен определять метод <code>Dispose()</code> без параметров, виртуальный метод <code>Dispose(bool)</code> и опциональный финализатор (деструктор). Наш пример не требует опционального финализатора (деструктора). А для <code>IAsyncDisposable</code> требуется определить методы без параметров <code>DisposeAsync()</code> и <code>DisposeAsyncCore()</code>. Оба пути утилизации (синхронный и асинхронный) могут сработать, поэтому они оба должны быть готовы утилизировать ресурсы. В методе <code>Dispose(bool)</code> не только вызывается <code>Dispose()</code> для синхронного ресурса syncDisposeObj, но и произвоится попытка вызвать <code>Dispose()</code> для асинхронного asyncDisposeObj. Отметьте, что <code>Dispose(bool)</code> также вызывает <code>DisposeThisObject</code>, который содержит тот же код, что и аналогичный код для асинхронного пути во избежание дублирования. </p>
<p>Методы <code>Dispose()</code> и <code>DisposeAsync()</code> являются членами интерфейсов, а методы <code>Dispose(bool)</code> и <code>DisposeAsyncCore()</code> - конвенциями (условленными договоренностями). Оба последних метода виртуальные. Это является частью паттерна, когда производный класс может реализовать утилизацию ресурсов, переопределяя эти методы и вызывая их через <code>base.Dispose(bool)</code> и <code>base.DisposeAsyncCore()</code>, чтобы гарантировать освобождение ресурсов по всей иерархии наследования.</p>
<p>Оба метода <code>Dispose()</code> и <code>DisposeAsync()</code> вызывают  <code>Dispose(bool)</code>, но <code>DisposeAsync()</code> устанавливает флаг <code>disposing</code> в false. Напомню, что <code>disposing = true</code> это флаг утилизации управляемых ресурсов. Метод <code>Dispose(bool)</code> - это синхронный путь, а метод <code>DisposeAsync()</code> вызывает <code>DisposeAsyncCore()</code> для утилизирования асинхронных ресурсов. Как и <code>Dispose(true)</code> метод <code>DisposeAsyncCore()</code> пытается высвободить все управляемые ресурсы. Асинхронный случай очевиден, однако синхронный имеет пару особенностей. Что если синхронный объект сейчас или в будущем реализует <code>IAsyncDisposable</code>? Тогда попытка вызова <code>DisposeAsync()</code> является наилучшим выбором в случае асинхронного пути выполнения кода. Иначе вызовется синхронный путь выполнения с методом <code>Dispose()</code>.</p>
<p>В конце отметим, что метод <code>Main</code> использует конструкцию <code>await using</code> при создании экземпляра класса реализующего интерфейсы <code>IAsyncDisposable</code> и <code>IDisposable</code>. Это гарантирует вызов метода <code>DisposeAsync()</code> по завершению выполнения метода <code>Main</code>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/02/20/iasyncdisposable/" data-id="cljdu3609000x8ovsdzh4bjxx" data-title="Имплементация интерфейса IAsyncDisposable" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-idisposable" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/19/idisposable/" class="article-date">
  <time class="dt-published" datetime="2022-02-19T08:18:09.000Z" itemprop="datePublished">19-02-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/19/idisposable/">Имплементация интерфейса IDisposable</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Интерфейс <code>IDisposable</code> служит для освобождения неуправляемых ресурсов (unmanaged resources). Сборщик мусора в .NET автоматически не освобождает неуправляемую память. Поэтому разработан шаблон освобождения неуправляемых ресурсов (Dispose Pattern), таких как файловые дескрипторы, указатели на блоки неуправляемой памяти, дескрипторы реестра и т.п. Для освобождения неуправляемых ресурсов объект должен реализовывать интерфейс <code>IDisposable</code>.</p>
<p>Интерфейс <code>IDisposable</code> требует имплементации метода без параметров <code>Dispose()</code>, а незапечатанные (non-sealed) классы дополнительно должны перегружать метод <code>Dispose(bool)</code>. Чтобы обеспечить правильное освобождение ресурсов, метод Dispose должен быть идемпотентным (т.е. чтобы его можно было без вреда вызывать несколько раз). Все последующие после первого вызовы Dispose() ничего не должны делать.</p>
<p>Стандартная реализация публичного невиртуального метода <code>Dispose()</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Dispose(<span class="literal">true</span>); <span class="comment">// Dispose of unmanaged resources</span></span><br><span class="line">    GC.SuppressFinalize(<span class="keyword">this</span>); <span class="comment">// Suppress finalization</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Перегруженный метод <code>Dispose(bool)</code> выполняет фактическую очистку всех объектов, поэтому сборщику мусора больше не нужно вызывать финализатор (деструктор) объектов. Таким образом, вызов метода SuppressFinalize предотвращает запуск финализатора (деструктора) сборщиком мусора. Если класс не имеет финализатора (деструктора), вызов <code>GC.SuppressFinalize</code> не будет оказывать никакого влияния.</p>
<p>В перегруженном методе <code>Dispose(bool)</code> аргумент метода указывает исходит ли вызов из метода Dispose (тогда его значение true) или из финализатора (тогда его значение false).</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_disposed)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (disposing)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> dispose managed state (managed objects).</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free unmanaged resources (unmanaged objects) and override a finalizer below.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> set large fields to null.</span></span><br><span class="line"></span><br><span class="line">    _disposed = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Метод немедленно возвращается, если очиска ресурсов уже имела место до этого. Отмечу, что блок выполняющий очистку неуправляемых ресурсов выполняется при любом значении аргумента disposing у метода. А вот блок освобождающий управляемые ресурсы запустится только в случае аргумента disposing равного true. Управляемые ресурсы могут состоять из объектов, реализующих IDisposable интерфейс (тогда у них просто надо каскадно вызвать Dispose() методы), либо из объектов, потребляющих большие объемы памяти или ограниченные ресурсы (тогда надо назначить ссылкам на них значение null, что освобождает их быстрее, чем если бы они были очищены в произвольный момент).</p>
<p>Если вызов метода происходит из финализатора (деструктора класса), то должен выполняться только код, освобождающий неуправляемые ресурсы, как показано ниже:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~A()</span><br><span class="line">&#123;</span><br><span class="line">    Dispose(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Разработчик отвечает за то, чтобы путь с аргументом false не взаимодействовал с управляемыми объектами, которые уже могли быть удалены. Это важно, потому что порядок в котором сборщик мусора удаляет управляемые объекты во время финализации недетерминирован.</p>
<p>Отмечу, что следует реализовать финализатор (деструктор) только в том случае, если у вас есть фактические неуправляемые ресурсы для удаления. Одна из основных причин реализовать финализатор (деструктор) состоит в том, что вы не может быть уверены инициализирован ли полностью экземпляр (например, в конструкторе может быть сгенерировано исключение). Однако если базовый класс может ссылаться только на управляемые объекты и реализовывать шаблон удаления, то в таком случае финализатор (деструктор) не нужен. Финализатор (деструктор класса) требуется только в том случае, если вы напрямую ссылаетесь на неуправляемые ресурсы. CLR обрабатывает финализируемые объекты иначе, чем нефинализируемые, даже если вызывается SuppressFinalize.</p>
<p>Когда класс реализует интерфейс IDisposable, это означает, что где-то есть неуправляемые ресурсы от которых следует избавиться, когда вы закончите использовать объект этого класса. Ресурсы инкапсулированы внутри класса и вам не нужно явно удалять их. Простой вызов <code>Dispose()</code> или обертывание класса в <code>using(...) &#123;&#125;</code> позволит избавиться от любых неуправляемых ресурсов автоматически.</p>
<p>Таким образом, вот общий шаблон для реализации Dispose Pattern:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">ClassWithFinalizer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// To detect redundant calls</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> _disposedValue;</span><br><span class="line"></span><br><span class="line">    ~ClassWithFinalizer() =&gt; Dispose(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Public implementation of Dispose pattern callable by consumers.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dispose(<span class="literal">true</span>);</span><br><span class="line">        GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Protected implementation of Dispose pattern.</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_disposedValue)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (disposing)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> dispose managed state (managed objects)</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> free unmanaged resources (unmanaged objects) and override finalizer</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> set large fields to null</span></span><br><span class="line">            _disposedValue = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/02/19/idisposable/" data-id="cljdu3605000q8ovs8ks7flau" data-title="Имплементация интерфейса IDisposable" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-processing-tasks-as-they-complete" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/10/processing-tasks-as-they-complete/" class="article-date">
  <time class="dt-published" datetime="2022-02-10T11:17:30.000Z" itemprop="datePublished">10-02-2022</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/10/processing-tasks-as-they-complete/">Перевод статьи Стефэна Тоуба &#34;Обработка задач по мере их завершения&#34;</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Данный пост является переводом статьи <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/pfxteam/processing-tasks-as-they-complete/">Stephen Toub “Processing tasks as they complete”</a>.</p>
<p>Недавно несколько человек спросили меня, как обрабатывать результаты выполнения задач по мере их завершения.</p>
<p>Допустим у разработчика есть несколько задач, представляющих асинхронные операции которые он инициировал, и он хочет обработать результаты выполнения этих задач, например:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Task&lt;T&gt;&gt; tasks = …;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> t <span class="keyword">in</span> tasks) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; Process(<span class="keyword">await</span> t); &#125;</span><br><span class="line">    catch(OperationCanceledException) &#123;&#125;</span><br><span class="line">    catch(Exception exc) &#123; Handle(exc); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Такой подход подходит для многих ситуаций. Однако он накладывает дополнительное ограничение при обработке, которое на самом деле не подразумевалось в исходной постановке задачи: этот код в конечном итоге обрабатывает задачи в той последовательности, в которой они были вызваны, а не в порядке их завершения, что означает, что некоторые задачи, которые уже были завершены, могут быть недоступны для обработки, поскольку предыдущая задача в последовательности может быть еще не завершена.</p>
<p>Есть много способов реализовать подобное решение. Один из подходов включает простое использование метода ContinueWith у Task, например:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Task&lt;T&gt;&gt; tasks = …;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> t <span class="keyword">in</span> tasks)</span><br><span class="line">    t.ContinueWith(completed =&gt; &#123;</span><br><span class="line">        <span class="keyword">switch</span>(completed.Status) &#123;</span><br><span class="line">            <span class="keyword">case</span> TaskStatus.RanToCompletion: Process(completed.Result); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> TaskStatus.Faulted: Handle(completed.Exception.InnerException); <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, TaskScheduler.Default);</span><br></pre></td></tr></table></figure>

<p>Это решение устраняет дополнительное ограничение, заключавшееся в том, что исходное решение заставляло обработку всех продолжений выполняться последовательно (и в исходном SynchronizationContext, если он был), тогда как данное решение позволяет выполнять обработку параллельно и в ThreadPool. Если вы хотите использовать данный подход, но также заставить задачи выполняться последовательно, можно сделать это, подставив сериализующий планировщик для метода ContinueWith (то есть планировщик, который заставит продолжения выполняться исключительно с оглядкой друг на друга). Например, вы можете использовать ConcurrentExclusiveSchedulerPair:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Task&lt;T&gt;&gt; tasks = …;</span><br><span class="line"><span class="keyword">var</span> scheduler = <span class="keyword">new</span> ConcurrentExclusiveSchedulerPair().ExclusiveScheduler;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> t <span class="keyword">in</span> tasks)</span><br><span class="line">    t.ContinueWith(completed =&gt; &#123;</span><br><span class="line">        <span class="keyword">switch</span>(completed.Status) &#123;</span><br><span class="line">            <span class="keyword">case</span> TaskStatus.RanToCompletion: Process(completed.Result); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> TaskStatus.Faulted: Handle(completed.Exception.InnerException); <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, scheduler);</span><br></pre></td></tr></table></figure>

<p>или если вы были в потоке пользовательского интерфейса вашего приложения вы могли бы предоставить планировщик, который представляет данный  поток пользовательского интерфейса, например:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scheduler = TaskScheduler.FromCurrentSynchronizationContext();</span><br></pre></td></tr></table></figure>

<p>Подход, основанный на методе ContinueWith, заставляет вас использовать модель, основанную на обратных вызовах (callbacks), для выполнения вашей обработки результатов. Если вы хотите, чтобы обработка выполнялась последовательно по мере завершения задач, но с использованием async/await, а не с использованием ContinueWith, это также возможно.</p>
<p>Есть несколько способов добиться этого. Относительно простой способ — использовать Task.WhenAny. WhenAny принимает набор задач и асинхронно предоставляет первую из них, которая завершится. Таким образом, вы можете многократно вызывать WhenAny, каждый раз удаляя ранее выполненную задачу, чтобы асинхронно ожидать завершения следующей:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Task&lt;T&gt;&gt; tasks = …;</span><br><span class="line"><span class="keyword">while</span>(tasks.Count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> t = <span class="keyword">await</span> Task.WhenAny(tasks);</span><br><span class="line">    tasks.Remove(t);</span><br><span class="line">    <span class="keyword">try</span> &#123; Process(<span class="keyword">await</span> t); &#125;</span><br><span class="line">    catch(OperationCanceledException) &#123;&#125;</span><br><span class="line">    catch(Exception exc) &#123; Handle(exc); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Функционально это норм, и пока количество задач невелико, производительность тоже должна быть в порядке. Однако, если количество задач становится велико, то это может привести к непренебрежимому снижению производительности. Здесь мы фактически создали алгоритм O(N^2): для каждой задачи мы ищем в списке задачу для ее удаления, что является операцией O(N), и мы регистрируем продолжение для каждой задачи, что тоже является операцией O(N). Например, если бы у нас было 10 000 задач, в течение всей этой операции мы бы в конечном итоге зарегистрировали и отменили регистрацию более 50 миллионов продолжений как части вызовов WhenAny. Правда не всё так плохо как кажется, поскольку WhenAny разумно управляет своими ресурсами, например: не регистрируя продолжения уже завершенных задач; останавливаясь, как только находит завершенную задачу; повторно используя один и тот же объект продолжения для всех задач и т. д. Тем не менее, здесь есть работа, которую мы можем избежать, если профилирование сочтёт этот код проблематичным.</p>
<p>Альтернативный подход заключается в создании нового метода «комбинатора», специально предназначенного для этой цели. При работе с коллекцией  экземпляров задач типа <code>Task&lt;T&gt;</code> метод WhenAny возвращает <code>Task&lt;Task&lt;T&gt;&gt;</code>; это задача, которая завершится, когда завершится первая из поставленных на выполнение задач, и результатом задачи <code>Task&lt;Task&lt;T&gt;&gt;</code> будет первая завершившаяся задача коллекции. В нашем случае нам нужна не только первая задача, но и все задачи, упорядоченные по мере их завершения. Мы можем представить это с помощью <code>Task&lt;Task&lt;T&gt;&gt;[]</code>. Воспринимайте это как массив корзин, куда мы будем помещать входящие задачи по мере их завершения, по одной задаче на корзину. Таким образом, если вы хотите, чтобы первая задача была завершена, вы можете дождаться (await) первой корзины этого массива, а если вы хотите, чтобы шестая задача была завершена, вы можете дождаться (await) шестой корзины этого массива.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">Task</span>&lt;<span class="title">Task</span>&lt;<span class="title">T</span>&gt;&gt; [] <span class="title">Interleaved</span>&lt;<span class="title">T</span>&gt;(<span class="params">IEnumerable&lt;Task&lt;T&gt;&gt; tasks</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> inputTasks = tasks.ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> buckets = <span class="keyword">new</span> TaskCompletionSource&lt;Task&lt;T&gt;&gt;[inputTasks.Count];</span><br><span class="line">    <span class="keyword">var</span> results = <span class="keyword">new</span> Task&lt;Task&lt;T&gt;&gt;[buckets.Length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; buckets.Length; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        buckets[i] = <span class="keyword">new</span> TaskCompletionSource&lt;Task&lt;T&gt;&gt;();</span><br><span class="line">        results[i] = buckets[i].Task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> nextTaskIndex = <span class="number">-1</span>;</span><br><span class="line">    Action&lt;Task&lt;T&gt;&gt; continuation = completed =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> bucket = buckets[Interlocked.Increment(<span class="keyword">ref</span> nextTaskIndex)];</span><br><span class="line">        bucket.TrySetResult(completed);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> inputTask <span class="keyword">in</span> inputTasks)</span><br><span class="line">        inputTask.ContinueWith(continuation, </span><br><span class="line">                               CancellationToken.None,</span><br><span class="line">                               TaskContinuationOptions.ExecuteSynchronously,</span><br><span class="line">                               TaskScheduler.Default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Итак, что здесь происходит? Сначала мы преобразуем наше перечисление задач в список <code>List&lt;Task&lt;T&gt;&gt;</code>; это делается для того, чтобы любые задачи, которые могут быть созданы ленивым отложенным способом путем перечисления перечисляемого, были материализованы один раз. Затем мы создаем экземпляры <code>TaskCompletionSource&lt;Task&lt;T&gt;&gt;</code> для представления корзин, по одной корзине на каждую задачу, которая в конечном итоге будет завершена. Затем мы цепляем продолжение к каждой входящей задаче: это продолжение получит следующую доступную корзину и сохранит в ней только что выполненную задачу. С помощью такого комбинатора можно переписать исходный код следующим образом:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Task&lt;T&gt;&gt; tasks = …;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="function"><span class="keyword">var</span> bucket <span class="keyword">in</span> <span class="title">Interleaved</span>(<span class="params">tasks</span>))</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> t = <span class="keyword">await</span> bucket;</span><br><span class="line">    <span class="keyword">try</span> &#123; Process(<span class="keyword">await</span> t); &#125;</span><br><span class="line">    catch(OperationCanceledException) &#123;&#125;</span><br><span class="line">    catch(Exception exc) &#123; Handle(exc); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Чтобы закрыть данное обсуждение, давайте посмотрим на то, что это даёт на практике. Рассмотрим:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tasks = <span class="keyword">new</span>[] &#123; </span><br><span class="line">    Task.Delay(<span class="number">3000</span>).ContinueWith(_ =&gt; <span class="number">3</span>),</span><br><span class="line">    Task.Delay(<span class="number">1000</span>).ContinueWith(_ =&gt; <span class="number">1</span>), </span><br><span class="line">    Task.Delay(<span class="number">2000</span>).ContinueWith(_ =&gt; <span class="number">2</span>),</span><br><span class="line">    Task.Delay(<span class="number">5000</span>).ContinueWith(_ =&gt; <span class="number">5</span>),</span><br><span class="line">    Task.Delay(<span class="number">4000</span>).ContinueWith(_ =&gt; <span class="number">4</span>),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> bucket <span class="keyword">in</span> <span class="title">Interleaved</span>(<span class="params">tasks</span>))</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> t = <span class="keyword">await</span> bucket;</span><br><span class="line">    <span class="built_in">int</span> result = <span class="keyword">await</span> t;</span><br><span class="line">    Console.WriteLine(“&#123;<span class="number">0</span>&#125;: &#123;<span class="number">1</span>&#125;”, DateTime.Now, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>У нас есть массив задач Task<int>, каждая из которых завершится через N секунд и вернет целое число N (например, первая задача в массиве завершится через 3 секунды и вернет число 3). Затем мы перебираем эти задачи, используя наш самодельный метод Interleaved, распечатывая результаты по мере их получения. Когда я запускаю этот код, я вижу следующий вывод:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">37</span>:<span class="number">48</span> AM: <span class="number">1</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">37</span>:<span class="number">49</span> AM: <span class="number">2</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">37</span>:<span class="number">50</span> AM: <span class="number">3</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">37</span>:<span class="number">51</span> AM: <span class="number">4</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">37</span>:<span class="number">52</span> AM: <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>и это именно то поведение, которое мы хотели. Обратите внимание на время вывода каждого элемента. Все задачи были запущены одновременно, поэтому все их таймеры работают одновременно. По мере того как каждая задача завершается, наш цикл может обработать её, и в результате мы получаем по одной строке вывода каждую секунду.</p>
<p>Для контраста рассмотрим тот же пример, но без использования Interleaved:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tasks = <span class="keyword">new</span>[] &#123; </span><br><span class="line">    Task.Delay(<span class="number">3000</span>).ContinueWith(_ =&gt; <span class="number">3</span>),</span><br><span class="line">    Task.Delay(<span class="number">1000</span>).ContinueWith(_ =&gt; <span class="number">1</span>), </span><br><span class="line">    Task.Delay(<span class="number">2000</span>).ContinueWith(_ =&gt; <span class="number">2</span>),</span><br><span class="line">    Task.Delay(<span class="number">5000</span>).ContinueWith(_ =&gt; <span class="number">5</span>),</span><br><span class="line">    Task.Delay(<span class="number">4000</span>).ContinueWith(_ =&gt; <span class="number">4</span>),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> tasks) &#123;</span><br><span class="line">    <span class="built_in">int</span> result = <span class="keyword">await</span> t;</span><br><span class="line">    Console.WriteLine(“&#123;<span class="number">0</span>&#125;: &#123;<span class="number">1</span>&#125;”, DateTime.Now, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>При запуске этого варианта видим:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">42</span>:<span class="number">08</span> AM: <span class="number">3</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">42</span>:<span class="number">08</span> AM: <span class="number">1</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">42</span>:<span class="number">08</span> AM: <span class="number">2</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">42</span>:<span class="number">10</span> AM: <span class="number">5</span></span><br><span class="line"><span class="number">8</span>/<span class="number">2</span>/<span class="number">2012</span> <span class="number">7</span>:<span class="number">42</span>:<span class="number">10</span> AM: <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>А теперь взгляните на время. Поскольку идёт обработка задач по порядку, мы не можем распечатать результаты для задачи 1 или задачи 2 до тех пор, пока задача 3 не будет завершена (поскольку она была перед ними в массиве). Точно так же мы не можем распечатать результат для задачи 4, пока задача 5 не будет завершена.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ostart.github.io/2022/02/10/processing-tasks-as-they-complete/" data-id="cljdu360k001e8ovs4sls3zuh" data-title="Перевод статьи Стефэна Тоуба &#34;Обработка задач по мере их завершения&#34;" class="article-share-link">Поделиться</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C#</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Назад</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">Вперед &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Метки</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/NET5/" rel="tag">.NET5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NET6/" rel="tag">.NET6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASP-NETCore/" rel="tag">ASP.NETCore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/" rel="tag">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Benchmark/" rel="tag">Benchmark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BenchmarkDotNet/" rel="tag">BenchmarkDotNet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Calendar/" rel="tag">Calendar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ClearScript/" rel="tag">ClearScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Commandline/" rel="tag">Commandline</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CreateReactApp/" rel="tag">CreateReactApp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DateTime/" rel="tag">DateTime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DefaultRequestHeaders/" rel="tag">DefaultRequestHeaders</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EFCore5/" rel="tag">EFCore5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EFCore6/" rel="tag">EFCore6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EPPlus/" rel="tag">EPPlus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ESLint/" rel="tag">ESLint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EntityFramework/" rel="tag">EntityFramework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Enum/" rel="tag">Enum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Excel/" rel="tag">Excel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GetWeekOfYear/" rel="tag">GetWeekOfYear</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Guid/" rel="tag">Guid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Headers/" rel="tag">Headers</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HttpClient/" rel="tag">HttpClient</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Husky/" rel="tag">Husky</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ILSpy/" rel="tag">ILSpy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ISOWeek/" rel="tag">ISOWeek</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LEFTJOIN/" rel="tag">LEFTJOIN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LINQ/" rel="tag">LINQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MicrosoftSQLServer/" rel="tag">MicrosoftSQLServer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSIS/" rel="tag">NSIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NuGet/" rel="tag">NuGet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OWIN/" rel="tag">OWIN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OrderBy/" rel="tag">OrderBy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prettier/" rel="tag">Prettier</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ProgressiveDelayPattern/" rel="tag">ProgressiveDelayPattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPM/" rel="tag">RPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SNMP/" rel="tag">SNMP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPEC/" rel="tag">SPEC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SelectMany/" rel="tag">SelectMany</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stopwatch/" rel="tag">Stopwatch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger/" rel="tag">Swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ToDictionary/" rel="tag">ToDictionary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ToLookup/" rel="tag">ToLookup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TopShelf/" rel="tag">TopShelf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/" rel="tag">VSCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Venis-IX/" rel="tag">Venis_IX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VisualStudio/" rel="tag">VisualStudio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebAPI/" rel="tag">WebAPI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows-service/" rel="tag">Windows-service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aspnetcore/" rel="tag">aspnetcore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/" rel="tag">bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/concurrency/" rel="tag">concurrency</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cursor/" rel="tag">cursor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/get-request/" rel="tag">get-request</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/get-response/" rel="tag">get-response</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/githubpages/" rel="tag">githubpages</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/net5-0/" rel="tag">net5.0</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ngx-translate/" rel="tag">ngx-translate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nsis/" rel="tag">nsis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paging/" rel="tag">paging</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pragmatic-programmer/" rel="tag">pragmatic-programmer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/printer/" rel="tag">printer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/script/" rel="tag">script</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scripting/" rel="tag">scripting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/" rel="tag">server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/simulator/" rel="tag">simulator</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/snmp/" rel="tag">snmp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/snmpsim/" rel="tag">snmpsim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/switch/" rel="tag">switch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/syslog/" rel="tag">syslog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thread-safe/" rel="tag">thread-safe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D0%A2%D0%BE%D0%BC%D0%B0%D1%81/" rel="tag">Томас</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D0%A5%D0%B0%D0%BD%D1%82/" rel="tag">Хант</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D0%B1%D0%BB%D0%BE%D0%B3/" rel="tag">блог</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D0%B4%D0%BE%D0%BA%D0%B5%D1%80/" rel="tag">докер</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D0%BF%D1%80%D0%B8%D0%BD%D1%82%D0%B5%D1%80/" rel="tag">принтер</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82-%D0%BF%D1%80%D0%B0%D0%B3%D0%BC%D0%B0%D1%82%D0%B8%D0%BA/" rel="tag">программист-прагматик</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D1%81%D0%B8%D0%BC%D1%83%D0%BB%D1%8F%D1%82%D0%BE%D1%80/" rel="tag">симулятор</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%D0%B1%D0%BB%D0%BE%D0%B3%D0%B0/" rel="tag">созданиеблога</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Облако меток</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET5/" style="font-size: 10px;">.NET5</a> <a href="/tags/NET6/" style="font-size: 10px;">.NET6</a> <a href="/tags/ASP-NETCore/" style="font-size: 10px;">ASP.NETCore</a> <a href="/tags/Angular/" style="font-size: 10px;">Angular</a> <a href="/tags/Benchmark/" style="font-size: 10px;">Benchmark</a> <a href="/tags/BenchmarkDotNet/" style="font-size: 10px;">BenchmarkDotNet</a> <a href="/tags/C/" style="font-size: 20px;">C#</a> <a href="/tags/Calendar/" style="font-size: 10px;">Calendar</a> <a href="/tags/ClearScript/" style="font-size: 12.5px;">ClearScript</a> <a href="/tags/Commandline/" style="font-size: 10px;">Commandline</a> <a href="/tags/CreateReactApp/" style="font-size: 10px;">CreateReactApp</a> <a href="/tags/DateTime/" style="font-size: 10px;">DateTime</a> <a href="/tags/DefaultRequestHeaders/" style="font-size: 10px;">DefaultRequestHeaders</a> <a href="/tags/EFCore5/" style="font-size: 10px;">EFCore5</a> <a href="/tags/EFCore6/" style="font-size: 10px;">EFCore6</a> <a href="/tags/EPPlus/" style="font-size: 10px;">EPPlus</a> <a href="/tags/ESLint/" style="font-size: 10px;">ESLint</a> <a href="/tags/EntityFramework/" style="font-size: 12.5px;">EntityFramework</a> <a href="/tags/Enum/" style="font-size: 10px;">Enum</a> <a href="/tags/Excel/" style="font-size: 10px;">Excel</a> <a href="/tags/GetWeekOfYear/" style="font-size: 10px;">GetWeekOfYear</a> <a href="/tags/Guid/" style="font-size: 10px;">Guid</a> <a href="/tags/Headers/" style="font-size: 10px;">Headers</a> <a href="/tags/HttpClient/" style="font-size: 10px;">HttpClient</a> <a href="/tags/Husky/" style="font-size: 10px;">Husky</a> <a href="/tags/ILSpy/" style="font-size: 10px;">ILSpy</a> <a href="/tags/ISOWeek/" style="font-size: 10px;">ISOWeek</a> <a href="/tags/JS/" style="font-size: 12.5px;">JS</a> <a href="/tags/JavaScript/" style="font-size: 12.5px;">JavaScript</a> <a href="/tags/LEFTJOIN/" style="font-size: 10px;">LEFTJOIN</a> <a href="/tags/LINQ/" style="font-size: 17.5px;">LINQ</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MicrosoftSQLServer/" style="font-size: 10px;">MicrosoftSQLServer</a> <a href="/tags/NSIS/" style="font-size: 15px;">NSIS</a> <a href="/tags/NuGet/" style="font-size: 12.5px;">NuGet</a> <a href="/tags/OWIN/" style="font-size: 10px;">OWIN</a> <a href="/tags/OrderBy/" style="font-size: 10px;">OrderBy</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Prettier/" style="font-size: 10px;">Prettier</a> <a href="/tags/ProgressiveDelayPattern/" style="font-size: 10px;">ProgressiveDelayPattern</a> <a href="/tags/RPM/" style="font-size: 12.5px;">RPM</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/SNMP/" style="font-size: 15px;">SNMP</a> <a href="/tags/SPEC/" style="font-size: 10px;">SPEC</a> <a href="/tags/SelectMany/" style="font-size: 10px;">SelectMany</a> <a href="/tags/Stopwatch/" style="font-size: 10px;">Stopwatch</a> <a href="/tags/Swagger/" style="font-size: 10px;">Swagger</a> <a href="/tags/ToDictionary/" style="font-size: 10px;">ToDictionary</a> <a href="/tags/ToLookup/" style="font-size: 10px;">ToLookup</a> <a href="/tags/TopShelf/" style="font-size: 10px;">TopShelf</a> <a href="/tags/VSCode/" style="font-size: 10px;">VSCode</a> <a href="/tags/Venis-IX/" style="font-size: 10px;">Venis_IX</a> <a href="/tags/VisualStudio/" style="font-size: 10px;">VisualStudio</a> <a href="/tags/WebAPI/" style="font-size: 10px;">WebAPI</a> <a href="/tags/Windows-service/" style="font-size: 12.5px;">Windows-service</a> <a href="/tags/aspnetcore/" style="font-size: 10px;">aspnetcore</a> <a href="/tags/bash/" style="font-size: 12.5px;">bash</a> <a href="/tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="/tags/cursor/" style="font-size: 10px;">cursor</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/get-request/" style="font-size: 10px;">get-request</a> <a href="/tags/get-response/" style="font-size: 10px;">get-response</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/githubpages/" style="font-size: 10px;">githubpages</a> <a href="/tags/net5-0/" style="font-size: 10px;">net5.0</a> <a href="/tags/ngx-translate/" style="font-size: 10px;">ngx-translate</a> <a href="/tags/nsis/" style="font-size: 15px;">nsis</a> <a href="/tags/paging/" style="font-size: 10px;">paging</a> <a href="/tags/pragmatic-programmer/" style="font-size: 10px;">pragmatic-programmer</a> <a href="/tags/printer/" style="font-size: 12.5px;">printer</a> <a href="/tags/script/" style="font-size: 12.5px;">script</a> <a href="/tags/scripting/" style="font-size: 10px;">scripting</a> <a href="/tags/server/" style="font-size: 10px;">server</a> <a href="/tags/simulator/" style="font-size: 12.5px;">simulator</a> <a href="/tags/snmp/" style="font-size: 12.5px;">snmp</a> <a href="/tags/snmpsim/" style="font-size: 12.5px;">snmpsim</a> <a href="/tags/switch/" style="font-size: 12.5px;">switch</a> <a href="/tags/syslog/" style="font-size: 10px;">syslog</a> <a href="/tags/thread-safe/" style="font-size: 10px;">thread-safe</a> <a href="/tags/%D0%A2%D0%BE%D0%BC%D0%B0%D1%81/" style="font-size: 10px;">Томас</a> <a href="/tags/%D0%A5%D0%B0%D0%BD%D1%82/" style="font-size: 10px;">Хант</a> <a href="/tags/%D0%B1%D0%BB%D0%BE%D0%B3/" style="font-size: 10px;">блог</a> <a href="/tags/%D0%B4%D0%BE%D0%BA%D0%B5%D1%80/" style="font-size: 10px;">докер</a> <a href="/tags/%D0%BF%D1%80%D0%B8%D0%BD%D1%82%D0%B5%D1%80/" style="font-size: 12.5px;">принтер</a> <a href="/tags/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82-%D0%BF%D1%80%D0%B0%D0%B3%D0%BC%D0%B0%D1%82%D0%B8%D0%BA/" style="font-size: 10px;">программист-прагматик</a> <a href="/tags/%D1%81%D0%B8%D0%BC%D1%83%D0%BB%D1%8F%D1%82%D0%BE%D1%80/" style="font-size: 12.5px;">симулятор</a> <a href="/tags/%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%D0%B1%D0%BB%D0%BE%D0%B3%D0%B0/" style="font-size: 10px;">созданиеблога</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Архив</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">июнь 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">апрель 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">декабрь 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">апрель 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">март 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">февраль 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">декабрь 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">ноябрь 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">октябрь 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">сентябрь 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">август 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">июль 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">июнь 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Недавние записи</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/06/27/nuget-cache-clearing/">Очистка кэша NuGet пакетов</a>
          </li>
        
          <li>
            <a href="/2023/06/25/select-problem-ngx-translate-angular/">Об одной проблеме работы ngx-translate при первоначальной загрузке сайта на Angular</a>
          </li>
        
          <li>
            <a href="/2023/04/13/contains-is-deprecated-in-efcore6/">Метод Contains больше не поддерживается в EF Core 6</a>
          </li>
        
          <li>
            <a href="/2022/12/21/required-query-string-in-aspnet-core/">Обязательный QueryString параметр в ASP.NET Core</a>
          </li>
        
          <li>
            <a href="/2022/12/21/restore-db-postgres/">Как восстановить базу данных из файла бэкапа в PostgreSQL</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 Artem Ostashchenko<br>
      Создано с помощью <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a target="_blank" rel="noopener" href="https://github.com/ostart/Skills" class="mobile-nav-link">My Skills</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>